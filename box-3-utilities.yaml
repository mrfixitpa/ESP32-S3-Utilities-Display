# Box-3 Utilities Display (ESPHome Package)
# Version: 0.2.6
#
# Fix:
# - Font path for MDI now uses a RAW GitHub URL so it works from a remote package.
#
# Icons (per your codepoints):
# - HVAC flame: F0238
# - Electric:   F140C
# - Water:      F0E0A
# - Cooling:    F0717
#
# NOTE:
# Ensure the TTF exists in your GitHub repo at:
#   fonts/materialdesignicons-webfont.ttf

substitutions:
  thermostat_entity: climate.ecobee_thermostat

spi:
  clk_pin: GPIO7
  mosi_pin: GPIO6

interval:
  - interval: 30s
    then:
      - script.execute: request_draw

sensor:
  - platform: homeassistant
    id: avg_indoor_temp
    entity_id: sensor.average_indoor_temperature
    internal: true
    on_value:
      - script.execute: request_draw

  - platform: homeassistant
    id: outdoor_temp
    entity_id: sensor.outdoor_temperature
    internal: true
    on_value:
      - script.execute: request_draw

  - platform: homeassistant
    id: electric_power_w
    entity_id: sensor.house_electric_meter_power_minute_average
    internal: true
    on_value:
      - script.execute: request_draw

  - platform: homeassistant
    id: electric_energy_month
    entity_id: sensor.house_electric_meter_energy_this_month
    internal: true
    on_value:
      - script.execute: request_draw

  # Placeholders (swap later)
  - platform: template
    id: gas_now_flow
    lambda: |-
      return 0.0;
    update_interval: 5s
    internal: true
    on_value:
      - script.execute: request_draw

  - platform: template
    id: gas_month_ccf
    lambda: |-
      return 12.3;
    update_interval: 10s
    internal: true
    on_value:
      - script.execute: request_draw

  - platform: template
    id: water_now_flow
    lambda: |-
      return 0.0;
    update_interval: 5s
    internal: true
    on_value:
      - script.execute: request_draw

  - platform: template
    id: water_month_gal
    lambda: |-
      return 824;
    update_interval: 10s
    internal: true
    on_value:
      - script.execute: request_draw

text_sensor:
  - platform: homeassistant
    id: hvac_action
    entity_id: ${thermostat_entity}
    attribute: hvac_action
    internal: true
    on_value:
      - script.execute: request_draw

font:
  - file:
      type: gfonts
      family: Figtree
      weight: 600
    id: font_title
    size: 18

  - file:
      type: gfonts
      family: Figtree
      weight: 500
    id: font_label
    size: 14

  - file:
      type: gfonts
      family: Figtree
      weight: 700
    id: font_value
    size: 20

  # Material Design Icons (RAW URL so it resolves correctly from packages)
  - file: https://raw.githubusercontent.com/mrfixitpa/ESP32-S3-Utilities-Display/main/fonts/materialdesignicons-webfont.ttf
    id: font_mdi
    size: 22
    glyphs:
      - "\U000F0238" # flame
      - "\U000F140C" # electric
      - "\U000F0E0A" # water
      - "\U000F0717" # snowflake
      - "\u00B0"     # degree

display:
  - platform: ili9xxx
    model: S3BOX
    id: box_display
    cs_pin: GPIO5
    dc_pin: GPIO4
    reset_pin:
      number: GPIO48
      inverted: true
    invert_colors: false
    update_interval: never
    lambda: |-
      const Color paper = Color(255,255,255);
      const Color ink   = Color(0,0,0);
      const Color red   = Color(220,38,38);
      const Color blue  = Color(37,99,235);

      it.fill(paper);

      auto fill_round = [&](int x, int y, int w, int h, int r, Color c) {
        it.filled_rectangle(x+r, y, w-2*r, h, c);
        it.filled_rectangle(x, y+r, r, h-2*r, c);
        it.filled_rectangle(x+w-r, y+r, r, h-2*r, c);
        it.filled_circle(x+r, y+r, r, c);
        it.filled_circle(x+w-r-1, y+r, r, c);
        it.filled_circle(x+r, y+h-r-1, r, c);
        it.filled_circle(x+w-r-1, y+h-r-1, r, c);
      };

      auto tile = [&](int x, int y, int w, int h, int r) {
        fill_round(x, y, w, h, r, ink);
        fill_round(x+1, y+1, w-2, h-2, r-1, paper);
      };

      // Top strip spacing (matched)
      it.print(10, 8, id(font_label), ink, "Indoor");
      it.printf(62, 6, id(font_value), ink, "%.0f°", id(avg_indoor_temp).state);

      it.print(224, 8, id(font_label), ink, "Outdoor");
      it.printf(276, 6, id(font_value), ink, "%.0f°", id(outdoor_temp).state);

      // Center HVAC icon only (blank when idle)
      const std::string act = id(hvac_action).state;
      if (act == "heating") {
        it.print(152, 6, id(font_mdi), red, "\U000F0238");
      } else if (act == "cooling") {
        it.print(152, 6, id(font_mdi), blue, "\U000F0717");
      }

      it.line(10, 34, 310, 34, ink);

      int y = 44;
      const int h = 56;

      // Electricity
      tile(10, y, 300, h, 14);
      it.print(22, y+14, id(font_mdi), ink, "\U000F140C");
      it.print(44, y+10, id(font_title), ink, "Electricity");
      it.printf(44, y+34, id(font_label), ink, "Now %.0f W", id(electric_power_w).state);
      it.printf(170, y+34, id(font_label), ink, "Month %.1f kWh", id(electric_energy_month).state);

      // Gas (flame for now)
      y += h + 10;
      tile(10, y, 300, h, 14);
      it.print(22, y+14, id(font_mdi), ink, "\U000F0238");
      it.print(44, y+10, id(font_title), ink, "Gas");
      it.printf(44, y+34, id(font_label), ink, "Now %.2f", id(gas_now_flow).state);
      it.printf(170, y+34, id(font_label), ink, "Month %.1f CCF", id(gas_month_ccf).state);

      // Water
      y += h + 10;
      tile(10, y, 300, h, 14);
      it.print(22, y+14, id(font_mdi), ink, "\U000F0E0A");
      it.print(44, y+10, id(font_title), ink, "Water");
      it.printf(44, y+34, id(font_label), ink, "Now %.1f", id(water_now_flow).state);
      it.printf(170, y+34, id(font_label), ink, "Month %.0f gal", id(water_month_gal).state);

script:
  - id: request_draw
    mode: restart
    then:
      - component.update: box_display
